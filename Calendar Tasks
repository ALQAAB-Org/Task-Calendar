
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Calendar</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìÖ</text></svg>">
    <style>
        :root {
            /* Light mode variables */
            --bg-color: #f5f7fa;
            --text-color: #333;
            --container-bg: white;
            --header-border: #e0e0e0;
            --month-year-color: #2c3e50;
            --nav-btn-bg: #3498db;
            --nav-btn-hover: #2980b9;
            --today-btn-bg: #2ecc71;
            --today-btn-hover: #27ae60;
            --backup-btn-bg: #9b59b6;
            --backup-btn-hover: #8e44ad;
            --clear-btn-bg: #e74c3c;
            --clear-btn-hover: #c0392b;
            --custom-task-btn-bg: #f39c12;
            --custom-task-btn-hover: #d35400;
            --calendar-bg: white;
            --weekday-bg: #3498db;
            --weekday-color: white;
            --day-border: #e0e0e0;
            --day-hover: #f8f9fa;
            --other-month-bg: #f9f9f9;
            --other-month-color: #bdc3c7;
            --today-bg: #e8f4fd; /* Light blue background for today */
            --today-color: #3498db; /* Blue text for today */
            --task-bg: #f1f8e9;
            --task-border: #8bc34a;
            --modal-bg: white;
            --modal-header-border: #e0e0e0;
            --input-border: #ddd;
            --input-focus: #3498db;
            --btn-primary-bg: #3498db;
            --btn-primary-hover: #2980b9;
            --btn-secondary-bg: #95a5a6;
            --btn-secondary-hover: #7f8c8d;
            --btn-danger-bg: #e74c3c;
            --btn-danger-hover: #c0392b;
            --notification-bg: #2ecc71;
            --notification-error: #e74c3c;
            --empty-state-color: #7f8c8d;
            --task-count-bg: #3498db;
            --task-count-color: white;
            --tasks-list-bg: white;
            --task-item-bg: #f8f9fa;
            --task-item-hover: #f1f3f4;
            --filter-btn-bg: white;
            --filter-btn-border: #ddd;
            --filter-btn-active: #3498db;
            --current-indicator: #3498db;
            
            /* NEW: Updated current date highlight colors */
            --current-date-bg: #234C6A;
            --current-date-color: white;
            
            /* Task category colors for light mode */
            --task-personal-bg: #fce4ec;
            --task-personal-border: #e91e63;
            --task-personal-text: #880e4f;
            --task-work-bg: #e3f2fd;
            --task-work-border: #2196f3;
            --task-work-text: #0d47a1;
            --task-urgent-bg: #fff3e0;
            --task-urgent-border: #ff9800;
            --task-urgent-text: #e65100;
        }

        [data-theme="dark"] {
            /* Dark mode variables */
            --bg-color: #121212;
            --text-color: #e0e0e0;
            --container-bg: #1e1e1e;
            --header-border: #333;
            --month-year-color: #e0e0e0;
            --nav-btn-bg: #1976d2;
            --nav-btn-hover: #1565c0;
            --today-btn-bg: #388e3c;
            --today-btn-hover: #2e7d32;
            --backup-btn-bg: #7b1fa2;
            --backup-btn-hover: #6a1b9a;
            --clear-btn-bg: #d32f2f;
            --clear-btn-hover: #c62828;
            --custom-task-btn-bg: #f57c00;
            --custom-task-btn-hover: #ef6c00;
            --calendar-bg: #1e1e1e;
            --weekday-bg: #1976d2;
            --weekday-color: white;
            --day-border: #333;
            --day-hover: #2d2d2d;
            --other-month-bg: #252525;
            --other-month-color: #666;
            --today-bg: #1a237e; /* Keep dark navy for dark mode for contrast */
            --today-color: white; /* White text for dark mode */
            --task-bg: #1b5e20;
            --task-border: #4caf50;
            --modal-bg: #2d2d2d;
            --modal-header-border: #444;
            --input-border: #555;
            --input-focus: #1976d2;
            --btn-primary-bg: #1976d2;
            --btn-primary-hover: #1565c0;
            --btn-secondary-bg: #555;
            --btn-secondary-hover: #666;
            --btn-danger-bg: #d32f2f;
            --btn-danger-hover: #c62828;
            --notification-bg: #388e3c;
            --notification-error: #d32f2f;
            --empty-state-color: #aaa;
            --task-count-bg: #1976d2;
            --task-count-color: white;
            --tasks-list-bg: #1e1e1e;
            --task-item-bg: #252525;
            --task-item-hover: #2d2d2d;
            --filter-btn-bg: #2d2d2d;
            --filter-btn-border: #555;
            --filter-btn-active: #1976d2;
            --current-indicator: #1976d2;
            
            /* NEW: Updated current date highlight colors for dark mode */
            --current-date-bg: #F9F8F6;
            --current-date-color: #121212;
            
            /* Task category colors for dark mode */
            --task-personal-bg: #4a0030;
            --task-personal-border: #e91e63;
            --task-personal-text: #f8bbd9;
            --task-work-bg: #0d2b4e;
            --task-work-border: #2196f3;
            --task-work-text: #bbdefb;
            --task-urgent-bg: #4a2c00;
            --task-urgent-border: #ff9800;
            --task-urgent-text: #ffe0b2;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            min-height: 100vh;
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            width: 100%;
            max-width: 1440px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--header-border);
        }

        .header-controls {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 15px;
        }

        .month-year {
            font-size: clamp(24px, 4vw, 32px);
            font-weight: 600;
            color: var(--month-year-color);
            text-align: center;
            min-width: 250px;
        }

        .nav-btn {
            background-color: var(--nav-btn-bg);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 10px 16px;
            cursor: pointer;
            font-size: 15px;
            transition: all 0.3s;
            white-space: nowrap;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .nav-btn:hover {
            background-color: var(--nav-btn-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .today-btn {
            background-color: var(--today-btn-bg);
        }

        .today-btn:hover {
            background-color: var(--today-btn-hover);
        }

        .backup-btn {
            background-color: var(--backup-btn-bg);
        }

        .backup-btn:hover {
            background-color: var(--backup-btn-hover);
        }

        .clear-all-btn {
            background-color: var(--clear-btn-bg);
        }

        .clear-all-btn:hover {
            background-color: var(--clear-btn-hover);
        }

        .add-custom-task-btn {
            background-color: var(--custom-task-btn-bg);
        }

        .add-custom-task-btn:hover {
            background-color: var(--custom-task-btn-hover);
        }

        .theme-toggle-btn {
            background-color: var(--btn-secondary-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .theme-toggle-btn:hover {
            background-color: var(--btn-secondary-hover);
        }

        .theme-icon {
            font-size: 18px;
        }

        .calendar {
            background-color: var(--calendar-bg);
            border-radius: 10px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            margin-bottom: 30px;
            transition: background-color 0.3s;
        }

        .weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            background-color: var(--weekday-bg);
            color: var(--weekday-color);
            font-weight: 600;
        }

        .weekday {
            padding: 16px 10px;
            text-align: center;
            font-size: clamp(14px, 2.5vw, 18px);
            border-right: 1px solid rgba(255,255,255,0.2);
        }

        .weekday:last-child {
            border-right: none;
        }

        .days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            grid-auto-rows: 1fr;
            min-height: 800px;
        }

        .day {
            border: 1px solid var(--day-border);
            padding: 12px;
            position: relative;
            min-height: 140px;
            cursor: pointer;
            transition: all 0.2s;
            background-color: var(--calendar-bg);
        }

        .day:hover {
            background-color: var(--day-hover);
            transform: scale(1.02);
            z-index: 1;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .day-number {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
            position: relative;
            z-index: 2;
            display: inline-block;
            padding: 4px 8px;
            border-radius: 50%;
            min-width: 30px;
            text-align: center;
        }

        .other-month {
            color: var(--other-month-color);
            background-color: var(--other-month-bg);
        }

        /* NEW: Updated today styling with new colors */
        .today {
            background-color: var(--current-date-bg);
        }

        .today .day-number {
            color: var(--current-date-color);
            font-weight: 700;
            background-color: transparent; /* Remove the circle background */
        }

        .tasks {
            margin-top: 8px;
        }

        /* NEW: Improved task styling with truncation and overflow indicator */
        .task {
            padding: 6px 8px;
            margin-bottom: 6px;
            border-radius: 4px;
            font-size: 13px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 4px solid;
            position: relative;
            /* Ensure text doesn't overflow */
            max-width: 100%;
            display: block;
        }

        /* NEW: Improved overflow indicator with line and arrow */
        .task.truncated {
            padding-right: 20px;
        }

        .task.truncated::after {
            content: '';
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 16px;
            background: linear-gradient(90deg, transparent 0%, var(--task-bg) 30%, var(--task-bg) 100%);
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 4px;
            color: inherit;
            font-size: 10px;
            opacity: 0.9;
        }

        .task.truncated::before {
            content: '‚Üí';
            position: absolute;
            right: 4px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 2;
            font-size: 10px;
            color: inherit;
            opacity: 0.8;
        }

        .task:hover {
            transform: translateX(3px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .task.general {
            background-color: var(--task-bg);
            border-left-color: var(--task-border);
            color: var(--task-urgent-text);
        }

        .task.general.truncated::after {
            background: linear-gradient(90deg, transparent 0%, var(--task-bg) 30%, var(--task-bg) 100%);
        }

        .task.personal {
            background-color: var(--task-personal-bg);
            border-left-color: var(--task-personal-border);
            color: var(--task-personal-text);
        }

        .task.personal.truncated::after {
            background: linear-gradient(90deg, transparent 0%, var(--task-personal-bg) 30%, var(--task-personal-bg) 100%);
        }

        .task.work {
            background-color: var(--task-work-bg);
            border-left-color: var(--task-work-border);
            color: var(--task-work-text);
        }

        .task.work.truncated::after {
            background: linear-gradient(90deg, transparent 0%, var(--task-work-bg) 30%, var(--task-work-bg) 100%);
        }

        .task.urgent {
            background-color: var(--task-urgent-bg);
            border-left-color: var(--task-urgent-border);
            color: var(--task-urgent-text);
        }

        .task.urgent.truncated::after {
            background: linear-gradient(90deg, transparent 0%, var(--task-urgent-bg) 30%, var(--task-urgent-bg) 100%);
        }

        .task.completed {
            text-decoration: line-through;
            opacity: 0.7;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-content {
            background-color: var(--modal-bg);
            border-radius: 10px;
            width: 100%;
            max-width: 600px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            animation: modalAppear 0.3s ease-out;
            transition: background-color 0.3s;
        }

        @keyframes modalAppear {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--modal-header-border);
        }

        .modal-title {
            font-size: 22px;
            font-weight: 600;
            color: var(--month-year-color);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 26px;
            cursor: pointer;
            color: var(--empty-state-color);
            transition: color 0.3s;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .close-btn:hover {
            color: var(--clear-btn-bg);
            background-color: var(--day-hover);
        }

        .form-group {
            margin-bottom: 18px;
        }

        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: var(--month-year-color);
        }

        input, textarea, select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--input-border);
            border-radius: 6px;
            font-size: 16px;
            transition: border 0.3s, box-shadow 0.3s;
            background-color: var(--modal-bg);
            color: var(--text-color);
        }

        input:focus, textarea:focus, select:focus {
            border-color: var(--input-focus);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
            outline: none;
        }

        textarea {
            min-height: 120px;
            resize: vertical;
        }

        .date-range-row {
            display: flex;
            gap: 15px;
        }

        .date-range-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        .days-selection {
            margin-top: 15px;
        }

        .days-checkboxes {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .day-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .day-checkbox input {
            width: auto;
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 25px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 22px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            transition: all 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .btn-primary {
            background-color: var(--btn-primary-bg);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--btn-primary-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .btn-secondary {
            background-color: var(--btn-secondary-bg);
            color: white;
        }

        .btn-secondary:hover {
            background-color: var(--btn-secondary-hover);
            transform: translateY(-2px);
        }

        .btn-danger {
            background-color: var(--btn-danger-bg);
            color: white;
        }

        .btn-danger:hover {
            background-color: var(--btn-danger-hover);
            transform: translateY(-2px);
        }

        .backup-modal {
            display: none;
        }

        .backup-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin: 20px 0;
        }

        @media (min-width: 768px) {
            .backup-options {
                flex-direction: row;
            }
        }

        .backup-option {
            flex: 1;
            text-align: center;
            padding: 20px 15px;
            border: 2px solid var(--input-border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .backup-option:hover {
            border-color: var(--input-focus);
            background-color: var(--day-hover);
            transform: translateY(-3px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .backup-option.selected {
            border-color: var(--input-focus);
            background-color: var(--task-item-hover);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 26px;
            background-color: var(--notification-bg);
            color: white;
            border-radius: 6px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
            transform: translateX(150%);
            transition: transform 0.3s ease-in-out;
            z-index: 1100;
            max-width: 320px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            background-color: var(--notification-error);
        }

        .empty-state {
            text-align: center;
            padding: 12px;
            color: var(--empty-state-color);
            font-style: italic;
            font-size: 13px;
        }

        .task-count {
            position: absolute;
            top: 8px;
            right: 8px;
            background-color: var(--task-count-bg);
            color: var(--task-count-color);
            border-radius: 50%;
            width: 22px;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
        }

        .day.has-tasks .task-count {
            display: flex;
        }

        /* Tasks List Section */
        .tasks-list-section {
            background-color: var(--tasks-list-bg);
            border-radius: 10px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
            padding: 25px;
            margin-bottom: 30px;
            transition: background-color 0.3s;
        }

        .tasks-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--header-border);
        }

        .tasks-list-title {
            font-size: 22px;
            font-weight: 600;
            color: var(--month-year-color);
        }

        .tasks-list-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .sort-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sort-select {
            padding: 8px 12px;
            border: 1px solid var(--input-border);
            border-radius: 6px;
            background-color: var(--modal-bg);
            color: var(--text-color);
            font-size: 14px;
            cursor: pointer;
        }

        .sort-select:focus {
            outline: none;
            border-color: var(--input-focus);
        }

        .sort-direction {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 18px;
            color: var(--text-color);
            transition: all 0.3s;
            padding: 5px;
            border-radius: 4px;
        }

        .sort-direction:hover {
            background-color: var(--day-hover);
        }

        .tasks-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        /* NEW: Bulk selection styles */
        .bulk-actions {
            display: none;
            padding: 15px;
            background-color: var(--task-item-bg);
            border-radius: 8px;
            margin-bottom: 15px;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 10px;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .bulk-actions.show {
            display: flex;
        }

        .bulk-selection-info {
            font-weight: 500;
            color: var(--month-year-color);
        }

        .bulk-action-buttons {
            display: flex;
            gap: 10px;
        }

        .task-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-radius: 8px;
            background-color: var(--task-item-bg);
            transition: all 0.2s;
        }

        .task-item:hover {
            background-color: var(--task-item-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .task-item.selected {
            background-color: var(--today-bg);
            border: 1px solid var(--input-focus);
        }

        .task-checkbox {
            margin-right: 15px;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        /* NEW: Selection checkbox for bulk operations */
        .selection-checkbox {
            margin-right: 10px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .task-details {
            flex: 1;
        }

        .task-main-info {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 5px;
        }

        .task-title {
            font-weight: 600;
            font-size: 16px;
        }

        .task-date {
            color: var(--empty-state-color);
            font-size: 14px;
        }

        .task-category {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            color: white;
        }

        .task-category.general {
            background-color: #8bc34a;
        }

        .task-category.personal {
            background-color: #e91e63;
        }

        .task-category.work {
            background-color: #2196f3;
        }

        .task-category.urgent {
            background-color: #ff9800;
        }

        .task-description {
            color: var(--empty-state-color);
            font-size: 14px;
            margin-top: 5px;
            /* NEW: Ensure description doesn't overflow */
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .task-actions {
            display: flex;
            gap: 8px;
        }

        .task-action-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--empty-state-color);
            transition: color 0.3s;
            padding: 5px;
            border-radius: 4px;
        }

        .task-action-btn:hover {
            color: var(--input-focus);
            background-color: var(--day-hover);
        }

        .tasks-list-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 16px;
            border: 1px solid var(--filter-btn-border);
            border-radius: 6px;
            background-color: var(--filter-btn-bg);
            cursor: pointer;
            transition: all 0.3s;
            color: var(--text-color);
        }

        .filter-btn.active {
            background-color: var(--filter-btn-active);
            color: white;
            border-color: var(--filter-btn-active);
        }

        .current-day-indicator {
            position: absolute;
            top: 5px;
            left: 5px;
            width: 8px;
            height: 8px;
            background-color: var(--current-indicator);
            border-radius: 50%;
        }

        .today .current-day-indicator {
            background-color: var(--current-date-color);
        }

        .clear-all-modal {
            display: none;
        }

        /* NEW: Performance optimization classes */
        .performance-optimized {
            will-change: transform, opacity;
        }

        @media (max-width: 1024px) {
            .days {
                min-height: 700px;
            }
            
            .day {
                min-height: 120px;
                padding: 10px;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .days {
                min-height: 600px;
            }
            
            .day {
                min-height: 100px;
                padding: 8px;
            }
            
            .day-number {
                font-size: 14px;
            }
            
            .task {
                font-size: 12px;
                padding: 5px 7px;
            }
            
            .nav-btn {
                padding: 8px 14px;
                font-size: 14px;
            }
            
            .btn {
                padding: 10px 18px;
                font-size: 14px;
            }
            
            .task-main-info {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
            
            .date-range-row {
                flex-direction: column;
                gap: 10px;
            }
            
            .days-checkboxes {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .tasks-list-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .tasks-list-controls {
                width: 100%;
                justify-content: space-between;
            }

            .bulk-actions {
                flex-direction: column;
                align-items: flex-start;
            }

            .bulk-action-buttons {
                width: 100%;
                justify-content: space-between;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }
            
            .weekday {
                padding: 12px 5px;
                font-size: 12px;
            }
            
            .days {
                min-height: 500px;
            }
            
            .day {
                min-height: 90px;
                padding: 6px;
            }
            
            header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .header-controls {
                justify-content: center;
            }
            
            .month-year {
                min-width: auto;
            }
            
            .sort-controls {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-controls">
                <button class="nav-btn" id="prev-month">‚Üê Previous</button>
                <h1 class="month-year" id="current-month-year">January 2023</h1>
                <button class="nav-btn" id="next-month">Next ‚Üí</button>
                <button class="nav-btn today-btn" id="today-btn">Today</button>
            </div>
            <div class="header-controls">
                <button class="nav-btn add-custom-task-btn" id="add-custom-task-btn">Add Custom Task</button>
                <button class="nav-btn clear-all-btn" id="clear-all-btn">Clear All Tasks</button>
                <button class="nav-btn backup-btn" id="backup-btn">Backup & Restore</button>
                <button class="nav-btn theme-toggle-btn" id="theme-toggle-btn">
                    <span class="theme-icon" id="theme-icon">üåô</span>
                    <span id="theme-text">Dark Mode</span>
                </button>
            </div>
        </header>

        <div class="calendar">
            <div class="weekdays">
                <div class="weekday">Sunday</div>
                <div class="weekday">Monday</div>
                <div class="weekday">Tuesday</div>
                <div class="weekday">Wednesday</div>
                <div class="weekday">Thursday</div>
                <div class="weekday">Friday</div>
                <div class="weekday">Saturday</div>
            </div>
            <div class="days" id="calendar-days">
                <!-- Calendar days will be generated here -->
            </div>
        </div>

        <!-- Tasks List Section -->
        <div class="tasks-list-section">
            <div class="tasks-list-header">
                <h2 class="tasks-list-title">All Tasks</h2>
                <div class="tasks-list-controls">
                    <div class="sort-controls">
                        <select class="sort-select" id="sort-select">
                            <option value="recent">Recently Added</option>
                            <option value="oldest">Oldest First</option>
                            <option value="date">By Date</option>
                            <option value="title">By Title (A-Z)</option>
                            <option value="title-desc">By Title (Z-A)</option>
                            <option value="category">By Category</option>
                        </select>
                        <button class="sort-direction" id="sort-direction" title="Change sort direction">‚Üì</button>
                    </div>
                    <button class="nav-btn" id="toggle-completed">Hide Completed</button>
                </div>
            </div>
            
            <!-- NEW: Bulk actions bar -->
            <div class="bulk-actions" id="bulk-actions">
                <div class="bulk-selection-info" id="bulk-selection-info">0 tasks selected</div>
                <div class="bulk-action-buttons">
                    <button class="btn btn-danger" id="bulk-delete-btn">Delete Selected</button>
                    <button class="btn btn-secondary" id="clear-selection-btn">Clear Selection</button>
                </div>
            </div>
            
            <div class="tasks-list-filters">
                <button class="filter-btn active" data-filter="all">All</button>
                <button class="filter-btn" data-filter="general">General</button>
                <button class="filter-btn" data-filter="work">Work</button>
                <button class="filter-btn" data-filter="personal">Personal</button>
                <button class="filter-btn" data-filter="urgent">Urgent</button>
            </div>
            
            <div class="tasks-list" id="tasks-list">
                <!-- Tasks will be listed here -->
            </div>
        </div>
    </div>

    <!-- Add Task Modal -->
    <div class="modal" id="task-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="task-modal-title">Add New Task</h2>
                <button class="close-btn" id="close-task-modal">&times;</button>
            </div>
            <form id="task-form">
                <input type="hidden" id="task-date">
                <input type="hidden" id="task-id">
                
                <div class="form-group">
                    <label for="task-title">Task Title *</label>
                    <input type="text" id="task-title" required placeholder="Enter task title">
                </div>
                
                <div class="form-group">
                    <label for="task-description">Description</label>
                    <textarea id="task-description" placeholder="Enter task description (optional)"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="task-category">Category</label>
                    <select id="task-category">
                        <option value="general">General</option>
                        <option value="work">Work</option>
                        <option value="personal">Personal</option>
                        <option value="urgent">Urgent</option>
                    </select>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-danger" id="delete-task" style="display: none;">Delete Task</button>
                    <button type="button" class="btn btn-secondary" id="cancel-task">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Task</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Custom Task Modal -->
    <div class="modal" id="custom-task-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add Custom Task Range</h2>
                <button class="close-btn" id="close-custom-task-modal">&times;</button>
            </div>
            <form id="custom-task-form">
                <div class="form-group">
                    <label for="custom-task-title">Task Title *</label>
                    <input type="text" id="custom-task-title" required placeholder="Enter task title">
                </div>
                
                <div class="form-group">
                    <label for="custom-task-description">Description</label>
                    <textarea id="custom-task-description" placeholder="Enter task description (optional)"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="custom-task-category">Category</label>
                    <select id="custom-task-category">
                        <option value="general">General</option>
                        <option value="work">Work</option>
                        <option value="personal">Personal</option>
                        <option value="urgent">Urgent</option>
                    </select>
                </div>
                
                <div class="date-range-row">
                    <div class="form-group">
                        <label for="custom-task-start-date">Start Date *</label>
                        <input type="date" id="custom-task-start-date" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="custom-task-end-date">End Date *</label>
                        <input type="date" id="custom-task-end-date" required>
                    </div>
                </div>
                
                <div class="form-group days-selection">
                    <label>Select Days</label>
                    <div class="days-checkboxes">
                        <div class="day-checkbox">
                            <input type="checkbox" id="monday" value="1" checked>
                            <label for="monday">Monday</label>
                        </div>
                        <div class="day-checkbox">
                            <input type="checkbox" id="tuesday" value="2" checked>
                            <label for="tuesday">Tuesday</label>
                        </div>
                        <div class="day-checkbox">
                            <input type="checkbox" id="wednesday" value="3" checked>
                            <label for="wednesday">Wednesday</label>
                        </div>
                        <div class="day-checkbox">
                            <input type="checkbox" id="thursday" value="4" checked>
                            <label for="thursday">Thursday</label>
                        </div>
                        <div class="day-checkbox">
                            <input type="checkbox" id="friday" value="5" checked>
                            <label for="friday">Friday</label>
                        </div>
                        <div class="day-checkbox">
                            <input type="checkbox" id="saturday" value="6" checked>
                            <label for="saturday">Saturday</label>
                        </div>
                        <div class="day-checkbox">
                            <input type="checkbox" id="sunday" value="0" checked>
                            <label for="sunday">Sunday</label>
                        </div>
                        <div class="day-checkbox">
                            <input type="checkbox" id="select-all" checked>
                            <label for="select-all">Select All</label>
                        </div>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="cancel-custom-task">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Task Range</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Backup Modal -->
    <div class="modal backup-modal" id="backup-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Backup & Restore</h2>
                <button class="close-btn" id="close-backup-modal">&times;</button>
            </div>
            
            <div class="backup-options">
                <div class="backup-option" id="export-option">
                    <h3>Export Data</h3>
                    <p>Download your calendar data as a JSON file</p>
                </div>
                <div class="backup-option" id="import-option">
                    <h3>Import Data</h3>
                    <p>Upload a JSON file to restore your calendar</p>
                </div>
            </div>
            
            <div id="export-section">
                <button class="btn btn-primary" id="export-btn">Export Calendar Data</button>
            </div>
            
            <div id="import-section" style="display: none;">
                <div class="form-group">
                    <label for="import-file">Select backup file</label>
                    <input type="file" id="import-file" accept=".json">
                </div>
                <button class="btn btn-primary" id="import-btn">Import Calendar Data</button>
            </div>
        </div>
    </div>

    <!-- Clear All Tasks Modal -->
    <div class="modal clear-all-modal" id="clear-all-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Clear All Tasks</h2>
                <button class="close-btn" id="close-clear-all-modal">&times;</button>
            </div>
            
            <div class="form-group">
                <p style="font-size: 16px; line-height: 1.5; color: var(--clear-btn-bg);">
                    <strong>Warning:</strong> This action will permanently delete ALL tasks from your calendar. This cannot be undone.
                </p>
                <p style="margin-top: 10px; font-size: 14px; color: var(--empty-state-color);">
                    Are you sure you want to continue?
                </p>
            </div>
            
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" id="cancel-clear-all">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirm-clear-all">Yes, Clear All Tasks</button>
            </div>
        </div>
    </div>

    <!-- NEW: Bulk Delete Confirmation Modal -->
    <div class="modal" id="bulk-delete-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Delete Selected Tasks</h2>
                <button class="close-btn" id="close-bulk-delete-modal">&times;</button>
            </div>
            
            <div class="form-group">
                <p style="font-size: 16px; line-height: 1.5; color: var(--clear-btn-bg);">
                    <strong>Warning:</strong> You are about to delete <span id="bulk-delete-count">0</span> tasks. This action cannot be undone.
                </p>
                <p style="margin-top: 10px; font-size: 14px; color: var(--empty-state-color);">
                    Are you sure you want to continue?
                </p>
            </div>
            
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" id="cancel-bulk-delete">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirm-bulk-delete">Yes, Delete Tasks</button>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification">
        Operation completed successfully!
    </div>

    <script>
        // NEW: Simple IndexedDB wrapper with singleton pattern
        const DB_NAME = 'CalendarDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'tasks';

        class CalendarDB {
            constructor() {
                if (CalendarDB.instance) {
                    return CalendarDB.instance;
                }
                CalendarDB.instance = this;
                this.db = null;
                this.initPromise = null;
            }

            async init() {
                // Return existing initialization promise if available
                if (this.initPromise) {
                    return this.initPromise;
                }
                
                this.initPromise = new Promise((resolve, reject) => {
                    const request = indexedDB.open(DB_NAME, DB_VERSION);

                    request.onerror = () => {
                        console.error('IndexedDB initialization failed:', request.error);
                        reject(request.error);
                    };
                    
                    request.onsuccess = () => {
                        this.db = request.result;
                        console.log('IndexedDB initialized successfully');
                        resolve(this.db);
                    };

                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains(STORE_NAME)) {
                            const store = db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                            store.createIndex('date', 'date', { unique: false });
                            console.log('IndexedDB store created');
                        }
                    };
                    
                    request.onblocked = () => {
                        console.warn('IndexedDB opening blocked');
                    };
                });
                
                return this.initPromise;
            }

            async getAllTasks() {
                await this.ensureDB();
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([STORE_NAME], 'readonly');
                    const store = transaction.objectStore(STORE_NAME);
                    const request = store.getAll();

                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => resolve(request.result);
                    
                    transaction.oncomplete = () => {
                        console.log('Get all tasks transaction completed');
                    };
                });
            }

            async getTasksByDate(date) {
                await this.ensureDB();
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([STORE_NAME], 'readonly');
                    const store = transaction.objectStore(STORE_NAME);
                    const index = store.index('date');
                    const request = index.getAll(date);

                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => resolve(request.result);
                });
            }

            async saveTask(task) {
                await this.ensureDB();
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([STORE_NAME], 'readwrite');
                    const store = transaction.objectStore(STORE_NAME);
                    const request = store.put(task);

                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => resolve(request.result);
                    
                    transaction.oncomplete = () => {
                        console.log('Save task transaction completed');
                    };
                });
            }

            async deleteTask(id) {
                await this.ensureDB();
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([STORE_NAME], 'readwrite');
                    const store = transaction.objectStore(STORE_NAME);
                    const request = store.delete(id);

                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => resolve(request.result);
                    
                    transaction.oncomplete = () => {
                        console.log('Delete task transaction completed');
                    };
                });
            }

            async bulkDeleteTasks(ids) {
                await this.ensureDB();
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([STORE_NAME], 'readwrite');
                    const store = transaction.objectStore(STORE_NAME);
                    
                    let completed = 0;
                    let errors = [];

                    // Set up transaction completion handler
                    transaction.oncomplete = () => {
                        if (errors.length > 0) {
                            reject(errors);
                        } else {
                            resolve(ids.length);
                        }
                    };
                    
                    transaction.onerror = () => {
                        reject(transaction.error);
                    };

                    // Perform all deletions in single transaction
                    ids.forEach(id => {
                        const request = store.delete(id);
                        request.onerror = () => errors.push({ id, error: request.error });
                        request.onsuccess = () => completed++;
                    });
                });
            }

            async clearAllTasks() {
                await this.ensureDB();
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([STORE_NAME], 'readwrite');
                    const store = transaction.objectStore(STORE_NAME);
                    const request = store.clear();

                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => resolve();
                    
                    transaction.oncomplete = () => {
                        console.log('Clear all tasks transaction completed');
                    };
                });
            }
            
            // Ensure DB is initialized
            async ensureDB() {
                if (!this.db) {
                    await this.init();
                }
            }
        }

        // Calendar state
        let currentDate = new Date();
        let tasks = {};
        let selectedTaskIds = new Set(); // NEW: For bulk selection
        
        // Database instance (singleton)
        const calendarDB = new CalendarDB();

        // Get settings from localStorage or set defaults
        let showCompleted = localStorage.getItem('showCompleted') !== 'false'; // Default to true
        let currentFilter = localStorage.getItem('currentFilter') || 'all';
        let sortBy = localStorage.getItem('sortBy') || 'recent';
        let sortDirection = localStorage.getItem('sortDirection') || 'desc';

        // Theme state
        let isDarkMode = localStorage.getItem('darkMode') === 'true';

        // Performance optimization
        let renderScheduled = false;
        let taskRenderQueue = new Set();

        // DOM Elements
        const calendarDaysEl = document.getElementById('calendar-days');
        const currentMonthYearEl = document.getElementById('current-month-year');
        const prevMonthBtn = document.getElementById('prev-month');
        const nextMonthBtn = document.getElementById('next-month');
        const todayBtn = document.getElementById('today-btn');
        const backupBtn = document.getElementById('backup-btn');
        const clearAllBtn = document.getElementById('clear-all-btn');
        const addCustomTaskBtn = document.getElementById('add-custom-task-btn');
        const themeToggleBtn = document.getElementById('theme-toggle-btn');
        const themeIcon = document.getElementById('theme-icon');
        const themeText = document.getElementById('theme-text');
        
        // Modal elements
        const taskModal = document.getElementById('task-modal');
        const taskForm = document.getElementById('task-form');
        const taskModalTitle = document.getElementById('task-modal-title');
        const taskDateInput = document.getElementById('task-date');
        const taskIdInput = document.getElementById('task-id');
        const closeTaskModalBtn = document.getElementById('close-task-modal');
        const cancelTaskBtn = document.getElementById('cancel-task');
        const deleteTaskBtn = document.getElementById('delete-task');
        
        const customTaskModal = document.getElementById('custom-task-modal');
        const customTaskForm = document.getElementById('custom-task-form');
        const closeCustomTaskModalBtn = document.getElementById('close-custom-task-modal');
        const cancelCustomTaskBtn = document.getElementById('cancel-custom-task');
        const selectAllCheckbox = document.getElementById('select-all');
        const dayCheckboxes = document.querySelectorAll('.day-checkbox input[type="checkbox"]:not(#select-all)');
        
        const backupModal = document.getElementById('backup-modal');
        const closeBackupModalBtn = document.getElementById('close-backup-modal');
        const exportOption = document.getElementById('export-option');
        const importOption = document.getElementById('import-option');
        const exportSection = document.getElementById('export-section');
        const importSection = document.getElementById('import-section');
        const exportBtn = document.getElementById('export-btn');
        const importBtn = document.getElementById('import-btn');
        const importFileInput = document.getElementById('import-file');
        
        const clearAllModal = document.getElementById('clear-all-modal');
        const closeClearAllModalBtn = document.getElementById('close-clear-all-modal');
        const cancelClearAllBtn = document.getElementById('cancel-clear-all');
        const confirmClearAllBtn = document.getElementById('confirm-clear-all');
        
        // NEW: Bulk actions elements
        const bulkActionsEl = document.getElementById('bulk-actions');
        const bulkSelectionInfoEl = document.getElementById('bulk-selection-info');
        const bulkDeleteBtn = document.getElementById('bulk-delete-btn');
        const clearSelectionBtn = document.getElementById('clear-selection-btn');
        const bulkDeleteModal = document.getElementById('bulk-delete-modal');
        const bulkDeleteCountEl = document.getElementById('bulk-delete-count');
        const closeBulkDeleteModalBtn = document.getElementById('close-bulk-delete-modal');
        const cancelBulkDeleteBtn = document.getElementById('cancel-bulk-delete');
        const confirmBulkDeleteBtn = document.getElementById('confirm-bulk-delete');
        
        const notification = document.getElementById('notification');
        
        // Tasks list elements
        const tasksListEl = document.getElementById('tasks-list');
        const toggleCompletedBtn = document.getElementById('toggle-completed');
        const sortSelect = document.getElementById('sort-select');
        const sortDirectionBtn = document.getElementById('sort-direction');
        const filterBtns = document.querySelectorAll('.filter-btn');

        // Initialize the calendar
        async function initCalendar() {
            // Initialize database
            try {
                await calendarDB.init();
                await migrateFromLocalStorage();
                await loadTasks();
            } catch (error) {
                console.error('Failed to initialize database:', error);
                showNotification('Failed to initialize database. Using fallback storage.', true);
                // Fallback to localStorage if IndexedDB fails
                tasks = JSON.parse(localStorage.getItem('calendarTasks')) || {};
            }
            
            // Set initial theme
            setTheme(isDarkMode);
            
            // Apply saved settings
            applySavedSettings();
            
            renderCalendar();
            renderTasksList();
            setupEventListeners();
            
            // NEW: Register service worker for offline functionality
            registerServiceWorker();
        }

        // NEW: Register service worker
        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('Service Worker registered with scope:', registration.scope);
                    })
                    .catch(error => {
                        console.log('Service Worker registration failed:', error);
                    });
            }
        }

        // NEW: Migrate data from localStorage to IndexedDB
        async function migrateFromLocalStorage() {
            const localStorageData = localStorage.getItem('calendarTasks');
            if (!localStorageData) return;

            try {
                const oldTasks = JSON.parse(localStorageData);
                let migrationCount = 0;

                for (const [date, taskList] of Object.entries(oldTasks)) {
                    for (const task of taskList) {
                        // Ensure task has a date property for indexing
                        if (!task.date) {
                            task.date = date;
                        }
                        await calendarDB.saveTask(task);
                        migrationCount++;
                    }
                }

                if (migrationCount > 0) {
                    console.log(`Migrated ${migrationCount} tasks from localStorage to IndexedDB`);
                    localStorage.removeItem('calendarTasks'); // Clean up old data
                }
            } catch (error) {
                console.error('Migration failed:', error);
            }
        }

        // NEW: Load tasks from IndexedDB
        async function loadTasks() {
            try {
                const allTasks = await calendarDB.getAllTasks();
                // Convert array back to the expected object format
                tasks = {};
                allTasks.forEach(task => {
                    if (!tasks[task.date]) {
                        tasks[task.date] = [];
                    }
                    tasks[task.date].push(task);
                });
            } catch (error) {
                console.error('Failed to load tasks:', error);
                throw error;
            }
        }

        // NEW: Save task to IndexedDB
        async function saveTaskToDB(task) {
            try {
                await calendarDB.saveTask(task);
            } catch (error) {
                console.error('Failed to save task:', error);
                throw error;
            }
        }

        // NEW: Delete task from IndexedDB
        async function deleteTaskFromDB(taskId) {
            try {
                await calendarDB.deleteTask(taskId);
            } catch (error) {
                console.error('Failed to delete task:', error);
                throw error;
            }
        }

        // NEW: Bulk delete tasks from IndexedDB
        async function bulkDeleteTasksFromDB(taskIds) {
            try {
                await calendarDB.bulkDeleteTasks(Array.from(taskIds));
            } catch (error) {
                console.error('Failed to delete tasks:', error);
                throw error;
            }
        }

        // NEW: Clear all tasks from IndexedDB
        async function clearAllTasksFromDB() {
            try {
                await calendarDB.clearAllTasks();
            } catch (error) {
                console.error('Failed to clear all tasks:', error);
                throw error;
            }
        }

        // Apply saved settings to UI
        function applySavedSettings() {
            // Apply sort settings
            sortSelect.value = sortBy;
            sortDirectionBtn.textContent = sortDirection === 'asc' ? '‚Üë' : '‚Üì';
            
            // Apply completed tasks setting
            toggleCompletedBtn.textContent = showCompleted ? 'Hide Completed' : 'Show Completed';
            
            // Apply filter setting
            filterBtns.forEach(btn => {
                if (btn.getAttribute('data-filter') === currentFilter) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        // Save settings to localStorage
        function saveSettings() {
            localStorage.setItem('showCompleted', showCompleted);
            localStorage.setItem('currentFilter', currentFilter);
            localStorage.setItem('sortBy', sortBy);
            localStorage.setItem('sortDirection', sortDirection);
        }

        // Toggle theme function
        function toggleTheme() {
            isDarkMode = !isDarkMode;
            setTheme(isDarkMode);
            localStorage.setItem('darkMode', isDarkMode);
        }

        // Set theme based on state
        function setTheme(darkMode) {
            if (darkMode) {
                document.body.setAttribute('data-theme', 'dark');
                themeIcon.textContent = '‚òÄÔ∏è';
                themeText.textContent = 'Light Mode';
            } else {
                document.body.removeAttribute('data-theme');
                themeIcon.textContent = 'üåô';
                themeText.textContent = 'Dark Mode';
            }
        }

        // NEW: Performance-optimized render scheduling
        function scheduleRender() {
            if (!renderScheduled) {
                renderScheduled = true;
                requestAnimationFrame(() => {
                    renderCalendar();
                    renderTasksList();
                    renderScheduled = false;
                });
            }
        }

        // NEW: Optimized task rendering for specific dates
        function scheduleTaskRender(dateString) {
            taskRenderQueue.add(dateString);
            
            if (!renderScheduled) {
                renderScheduled = true;
                requestAnimationFrame(() => {
                    taskRenderQueue.forEach(date => {
                        renderTasksForDate(date);
                    });
                    taskRenderQueue.clear();
                    renderScheduled = false;
                });
            }
        }

        // Render the calendar for the current month
        function renderCalendar() {
            // Clear the calendar
            calendarDaysEl.innerHTML = '';
            
            // Set the current month and year in the header
            currentMonthYearEl.textContent = currentDate.toLocaleDateString('en-US', {
                month: 'long',
                year: 'numeric'
            });
            
            // Get the first day of the month and the number of days
            const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
            const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
            const daysInMonth = lastDay.getDate();
            
            // Get the day of the week for the first day (0 = Sunday, 6 = Saturday)
            const firstDayOfWeek = firstDay.getDay();
            
            // Get the last day of the previous month
            const prevMonthLastDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 0).getDate();
            
            // Create day elements for the previous month
            for (let i = firstDayOfWeek - 1; i >= 0; i--) {
                const day = document.createElement('div');
                day.className = 'day other-month';
                const dayNumber = prevMonthLastDay - i;
                day.innerHTML = `
                    <div class="day-number">${dayNumber}</div>
                    <div class="tasks"></div>
                `;
                calendarDaysEl.appendChild(day);
            }
            
            // Create day elements for the current month
            const today = new Date();
            for (let i = 1; i <= daysInMonth; i++) {
                const day = document.createElement('div');
                day.className = 'day performance-optimized';
                
                // Check if this day is today
                const isToday = (
                    currentDate.getFullYear() === today.getFullYear() &&
                    currentDate.getMonth() === today.getMonth() &&
                    i === today.getDate()
                );
                
                if (isToday) {
                    day.classList.add('today');
                }
                
                // Format the date string for this day (YYYY-MM-DD)
                const dateString = formatDate(new Date(currentDate.getFullYear(), currentDate.getMonth(), i));
                
                // Check if this day has tasks
                const hasTasks = tasks[dateString] && tasks[dateString].length > 0;
                const taskCount = hasTasks ? tasks[dateString].length : 0;
                
                day.innerHTML = `
                    ${isToday ? '<div class="current-day-indicator"></div>' : ''}
                    <div class="day-number">${i}</div>
                    ${hasTasks ? `<div class="task-count">${taskCount}</div>` : ''}
                    <div class="tasks" id="tasks-${dateString}"></div>
                `;
                
                if (hasTasks) {
                    day.classList.add('has-tasks');
                }
                
                // Add click event to open task modal
                day.addEventListener('click', () => openTaskModal(dateString));
                
                calendarDaysEl.appendChild(day);
                
                // Render tasks for this day
                renderTasksForDate(dateString);
            }
            
            // Calculate how many days from the next month we need to add
            const totalCells = 42; // 6 rows * 7 days
            const daysSoFar = firstDayOfWeek + daysInMonth;
            const nextMonthDays = totalCells - daysSoFar;
            
            // Create day elements for the next month
            for (let i = 1; i <= nextMonthDays; i++) {
                const day = document.createElement('div');
                day.className = 'day other-month';
                day.innerHTML = `
                    <div class="day-number">${i}</div>
                    <div class="tasks"></div>
                `;
                calendarDaysEl.appendChild(day);
            }
        }

        // Render tasks for a specific date
        function renderTasksForDate(dateString) {
            const tasksContainer = document.getElementById(`tasks-${dateString}`);
            if (!tasksContainer) return;
            
            // Clear and rebuild tasks container
            tasksContainer.innerHTML = '';
            
            if (tasks[dateString] && tasks[dateString].length > 0) {
                // Use DocumentFragment for better performance
                const fragment = document.createDocumentFragment();
                
                tasks[dateString].forEach(task => {
                    const taskEl = document.createElement('div');
                    taskEl.className = `task ${task.category} ${task.completed ? 'completed' : ''}`;
                    taskEl.textContent = task.title;
                    taskEl.title = task.description || task.title;
                    
                    // Check if text is truncated and add overflow indicator
                    setTimeout(() => {
                        if (taskEl.scrollWidth > taskEl.clientWidth) {
                            taskEl.classList.add('truncated');
                        }
                    }, 0);
                    
                    taskEl.addEventListener('click', (e) => {
                        e.stopPropagation();
                        editTask(dateString, task.id);
                    });
                    
                    fragment.appendChild(taskEl);
                });
                
                tasksContainer.appendChild(fragment);
            } else {
                tasksContainer.innerHTML = '<div class="empty-state">No tasks</div>';
            }
        }

        // Render the tasks list
        function renderTasksList() {
            tasksListEl.innerHTML = '';
            
            // Collect all tasks from all dates
            let allTasks = [];
            Object.keys(tasks).forEach(dateString => {
                if (tasks[dateString]) {
                    tasks[dateString].forEach(task => {
                        allTasks.push({
                            ...task,
                            date: dateString,
                            // Add creation timestamp if not exists (for backward compatibility)
                            createdAt: task.createdAt || Date.now()
                        });
                    });
                }
            });
            
            // Filter tasks
            if (currentFilter !== 'all') {
                allTasks = allTasks.filter(task => task.category === currentFilter);
            }
            
            // Filter completed tasks if needed
            if (!showCompleted) {
                allTasks = allTasks.filter(task => !task.completed);
            }
            
            // Sort tasks based on selected option
            allTasks = sortTasks(allTasks);
            
            // Display tasks or empty state
            if (allTasks.length === 0) {
                tasksListEl.innerHTML = '<div class="empty-state">No tasks found</div>';
                return;
            }
            
            // Use DocumentFragment for better performance
            const fragment = document.createDocumentFragment();
            
            // Create task items
            allTasks.forEach(task => {
                const taskItem = document.createElement('div');
                taskItem.className = `task-item performance-optimized ${selectedTaskIds.has(task.id) ? 'selected' : ''}`;
                
                const formattedDate = new Date(task.date).toLocaleDateString('en-US', {
                    weekday: 'short',
                    month: 'short',
                    day: 'numeric'
                });
                
                taskItem.innerHTML = `
                    <input type="checkbox" class="selection-checkbox" ${selectedTaskIds.has(task.id) ? 'checked' : ''}>
                    <input type="checkbox" class="task-checkbox" ${task.completed ? 'checked' : ''}>
                    <div class="task-details">
                        <div class="task-main-info">
                            <span class="task-title">${escapeHtml(task.title)}</span>
                            <span class="task-date">${formattedDate}</span>
                            <span class="task-category ${task.category}">${task.category}</span>
                        </div>
                        ${task.description ? `<div class="task-description" title="${escapeHtml(task.description)}">${escapeHtml(task.description)}</div>` : ''}
                    </div>
                    <div class="task-actions">
                        <button class="task-action-btn edit-task" title="Edit Task">‚úèÔ∏è</button>
                        <button class="task-action-btn delete-task" title="Delete Task">üóëÔ∏è</button>
                    </div>
                `;
                
                // Add event listeners
                const selectionCheckbox = taskItem.querySelector('.selection-checkbox');
                selectionCheckbox.addEventListener('change', () => toggleTaskSelection(task.id, selectionCheckbox.checked));
                
                const checkbox = taskItem.querySelector('.task-checkbox');
                checkbox.addEventListener('change', () => toggleTaskCompletion(task.date, task.id));
                
                const editBtn = taskItem.querySelector('.edit-task');
                editBtn.addEventListener('click', () => editTask(task.date, task.id));
                
                const deleteBtn = taskItem.querySelector('.delete-task');
                deleteBtn.addEventListener('click', () => deleteTaskFromList(task.date, task.id));
                
                fragment.appendChild(taskItem);
            });
            
            tasksListEl.appendChild(fragment);
            
            // NEW: Update bulk actions UI
            updateBulkActionsUI();
        }

        // Sort tasks based on current selection
        function sortTasks(tasks) {
            const direction = sortDirection === 'desc' ? -1 : 1;
            
            switch(sortBy) {
                case 'recent':
                    return tasks.sort((a, b) => direction * (b.createdAt - a.createdAt));
                case 'oldest':
                    return tasks.sort((a, b) => direction * (a.createdAt - b.createdAt));
                case 'date':
                    return tasks.sort((a, b) => direction * (new Date(a.date) - new Date(b.date)));
                case 'title':
                    return tasks.sort((a, b) => direction * a.title.localeCompare(b.title));
                case 'title-desc':
                    return tasks.sort((a, b) => direction * b.title.localeCompare(a.title));
                case 'category':
                    return tasks.sort((a, b) => direction * a.category.localeCompare(b.category));
                default:
                    return tasks;
            }
        }

        // NEW: Toggle task selection for bulk operations
        function toggleTaskSelection(taskId, isSelected) {
            if (isSelected) {
                selectedTaskIds.add(taskId);
            } else {
                selectedTaskIds.delete(taskId);
            }
            updateBulkActionsUI();
        }

        // NEW: Update bulk actions UI
        function updateBulkActionsUI() {
            const selectedCount = selectedTaskIds.size;
            
            if (selectedCount > 0) {
                bulkActionsEl.classList.add('show');
                bulkSelectionInfoEl.textContent = `${selectedCount} task${selectedCount !== 1 ? 's' : ''} selected`;
            } else {
                bulkActionsEl.classList.remove('show');
            }
        }

        // NEW: Clear all selections
        function clearSelections() {
            selectedTaskIds.clear();
            updateBulkActionsUI();
            renderTasksList(); // Re-render to update visual state
        }

        // NEW: Select all visible tasks
        function selectAllVisibleTasks() {
            // Collect all tasks from all dates
            let allTasks = [];
            Object.keys(tasks).forEach(dateString => {
                if (tasks[dateString]) {
                    tasks[dateString].forEach(task => {
                        allTasks.push({
                            ...task,
                            date: dateString
                        });
                    });
                }
            });
            
            // Filter tasks
            if (currentFilter !== 'all') {
                allTasks = allTasks.filter(task => task.category === currentFilter);
            }
            
            // Filter completed tasks if needed
            if (!showCompleted) {
                allTasks = allTasks.filter(task => !task.completed);
            }
            
            // Add all visible tasks to selection
            allTasks.forEach(task => {
                selectedTaskIds.add(task.id);
            });
            
            updateBulkActionsUI();
            renderTasksList(); // Re-render to update visual state
        }

        // NEW: Bulk delete selected tasks
        async function bulkDeleteSelectedTasks() {
            const selectedCount = selectedTaskIds.size;
            if (selectedCount === 0) return;

            // Show confirmation modal
            bulkDeleteCountEl.textContent = selectedCount;
            bulkDeleteModal.style.display = 'flex';
        }

        // NEW: Perform the actual bulk deletion
        async function performBulkDelete() {
            const taskIdsToDelete = Array.from(selectedTaskIds);
            
            try {
                // Remove from IndexedDB in single transaction
                await bulkDeleteTasksFromDB(taskIdsToDelete);
                
                // Remove from local state
                taskIdsToDelete.forEach(taskId => {
                    for (const date in tasks) {
                        if (tasks[date]) {
                            tasks[date] = tasks[date].filter(task => task.id !== taskId);
                            if (tasks[date].length === 0) {
                                delete tasks[date];
                            }
                        }
                    }
                });
                
                // Clear selection
                clearSelections();
                
                // Update UI
                scheduleRender();
                
                // Show success notification
                showNotification(`${taskIdsToDelete.length} task${taskIdsToDelete.length !== 1 ? 's' : ''} deleted successfully`);
                
                // Close modal
                bulkDeleteModal.style.display = 'none';
            } catch (error) {
                console.error('Bulk delete failed:', error);
                showNotification('Failed to delete tasks. Please try again.', true);
            }
        }

        // Toggle task completion status
        async function toggleTaskCompletion(dateString, taskId) {
            if (tasks[dateString]) {
                const taskIndex = tasks[dateString].findIndex(t => t.id === taskId);
                if (taskIndex !== -1) {
                    tasks[dateString][taskIndex].completed = !tasks[dateString][taskIndex].completed;
                    try {
                        await saveTaskToDB(tasks[dateString][taskIndex]);
                        scheduleTaskRender(dateString);
                        renderTasksList();
                    } catch (error) {
                        console.error('Failed to update task:', error);
                        // Revert UI change on error
                        tasks[dateString][taskIndex].completed = !tasks[dateString][taskIndex].completed;
                        showNotification('Failed to update task. Please try again.', true);
                    }
                }
            }
        }

        // Delete task from tasks list
        async function deleteTaskFromList(dateString, taskId) {
            if (confirm('Are you sure you want to delete this task?')) {
                if (tasks[dateString]) {
                    const taskIndex = tasks[dateString].findIndex(t => t.id === taskId);
                    if (taskIndex !== -1) {
                        const task = tasks[dateString][taskIndex];
                        
                        try {
                            // Remove from IndexedDB
                            await deleteTaskFromDB(taskId);
                            
                            // Remove from local state
                            tasks[dateString] = tasks[dateString].filter(task => task.id !== taskId);
                            
                            // If no tasks left for this date, remove the date key
                            if (tasks[dateString].length === 0) {
                                delete tasks[dateString];
                            }
                            
                            // Remove from selection if selected
                            selectedTaskIds.delete(taskId);
                            
                            scheduleTaskRender(dateString);
                            renderTasksList();
                            showNotification('Task deleted successfully');
                        } catch (error) {
                            console.error('Failed to delete task:', error);
                            showNotification('Failed to delete task. Please try again.', true);
                        }
                    }
                }
            }
        }

        // Format date as YYYY-MM-DD
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // NEW: Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Open the task modal
        function openTaskModal(dateString, taskId = null) {
            taskDateInput.value = dateString;
            
            if (taskId) {
                // Editing an existing task
                taskModalTitle.textContent = 'Edit Task';
                const task = tasks[dateString].find(t => t.id === taskId);
                if (task) {
                    document.getElementById('task-title').value = task.title;
                    document.getElementById('task-description').value = task.description || '';
                    document.getElementById('task-category').value = task.category;
                    taskIdInput.value = taskId;
                    deleteTaskBtn.style.display = 'block';
                }
            } else {
                // Adding a new task
                taskModalTitle.textContent = 'Add New Task';
                document.getElementById('task-title').value = '';
                document.getElementById('task-description').value = '';
                document.getElementById('task-category').value = 'general';
                taskIdInput.value = '';
                deleteTaskBtn.style.display = 'none';
            }
            
            taskModal.style.display = 'flex';
            document.getElementById('task-title').focus();
        }

        // Edit an existing task
        function editTask(dateString, taskId) {
            openTaskModal(dateString, taskId);
        }

        // Save a task
        async function saveTask(event) {
            event.preventDefault();
            
            const dateString = taskDateInput.value;
            const taskId = taskIdInput.value;
            const title = document.getElementById('task-title').value.trim();
            const description = document.getElementById('task-description').value.trim();
            const category = document.getElementById('task-category').value;
            
            if (!title) {
                showNotification('Task title is required', true);
                document.getElementById('task-title').focus();
                return;
            }
            
            // Initialize tasks for this date if needed
            if (!tasks[dateString]) {
                tasks[dateString] = [];
            }
            
            let taskToSave;
            
            if (taskId) {
                // Update existing task
                const taskIndex = tasks[dateString].findIndex(t => t.id === taskId);
                if (taskIndex !== -1) {
                    taskToSave = {
                        id: taskId,
                        title,
                        description,
                        category,
                        date: dateString,
                        completed: tasks[dateString][taskIndex].completed || false,
                        createdAt: tasks[dateString][taskIndex].createdAt || Date.now()
                    };
                    tasks[dateString][taskIndex] = taskToSave;
                }
            } else {
                // Add new task
                taskToSave = {
                    id: Date.now().toString(),
                    title,
                    description,
                    category,
                    date: dateString,
                    completed: false,
                    createdAt: Date.now()
                };
                tasks[dateString].push(taskToSave);
            }
            
            try {
                // Save to IndexedDB
                await saveTaskToDB(taskToSave);
                
                // Update the UI
                scheduleTaskRender(dateString);
                renderTasksList();
                
                // Close the modal
                taskModal.style.display = 'none';
                
                // Show success notification
                showNotification(taskId ? 'Task updated successfully' : 'Task added successfully');
            } catch (error) {
                console.error('Failed to save task:', error);
                showNotification('Failed to save task. Please try again.', true);
                
                // Revert changes on error
                if (taskId) {
                    // In case of error during update, we'd need to reload the task
                    // For simplicity, we'll just reload all tasks
                    loadTasks().then(() => {
                        scheduleTaskRender(dateString);
                        renderTasksList();
                    });
                } else {
                    // Remove the task that was added
                    tasks[dateString] = tasks[dateString].filter(task => task.id !== taskToSave.id);
                }
            }
        }

        // Delete a task
        async function deleteTask() {
            const dateString = taskDateInput.value;
            const taskId = taskIdInput.value;
            
            if (dateString && taskId && tasks[dateString]) {
                if (confirm('Are you sure you want to delete this task?')) {
                    try {
                        // Remove from IndexedDB
                        await deleteTaskFromDB(taskId);
                        
                        // Remove from local state
                        tasks[dateString] = tasks[dateString].filter(task => task.id !== taskId);
                        
                        // If no tasks left for this date, remove the date key
                        if (tasks[dateString].length === 0) {
                            delete tasks[dateString];
                        }
                        
                        // Remove from selection if selected
                        selectedTaskIds.delete(taskId);
                        
                        // Update the UI
                        scheduleTaskRender(dateString);
                        renderTasksList();
                        
                        // Close the modal
                        taskModal.style.display = 'none';
                        
                        // Show success notification
                        showNotification('Task deleted successfully');
                    } catch (error) {
                        console.error('Failed to delete task:', error);
                        showNotification('Failed to delete task. Please try again.', true);
                    }
                }
            }
        }

        // Add custom task range
        async function addCustomTaskRange(event) {
            event.preventDefault();
            
            const title = document.getElementById('custom-task-title').value.trim();
            const description = document.getElementById('custom-task-description').value.trim();
            const category = document.getElementById('custom-task-category').value;
            const startDate = document.getElementById('custom-task-start-date').value;
            const endDate = document.getElementById('custom-task-end-date').value;
            
            if (!title) {
                showNotification('Task title is required', true);
                document.getElementById('custom-task-title').focus();
                return;
            }
            
            if (!startDate || !endDate) {
                showNotification('Start and end dates are required', true);
                return;
            }
            
            const start = new Date(startDate);
            const end = new Date(endDate);
            
            if (start > end) {
                showNotification('Start date must be before end date', true);
                return;
            }
            
            // Get selected days
            const selectedDays = [];
            dayCheckboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    selectedDays.push(parseInt(checkbox.value));
                }
            });
            
            if (selectedDays.length === 0) {
                showNotification('Please select at least one day', true);
                return;
            }
            
            let current = new Date(start);
            let taskCount = 0;
            const timestamp = Date.now();
            const tasksToSave = [];
            const datesToRender = new Set();
            
            while (current <= end) {
                const dayOfWeek = current.getDay();
                
                // Check if this day is selected
                if (selectedDays.includes(dayOfWeek)) {
                    const dateString = formatDate(current);
                    
                    // Initialize tasks for this date if needed
                    if (!tasks[dateString]) {
                        tasks[dateString] = [];
                    }
                    
                    // Add task
                    const newTask = {
                        id: timestamp + '-' + taskCount,
                        title,
                        description,
                        category,
                        date: dateString,
                        completed: false,
                        createdAt: timestamp
                    };
                    tasks[dateString].push(newTask);
                    tasksToSave.push(newTask);
                    datesToRender.add(dateString);
                    taskCount++;
                }
                
                // Move to next day
                current.setDate(current.getDate() + 1);
            }
            
            try {
                // Save all tasks to IndexedDB
                for (const task of tasksToSave) {
                    await saveTaskToDB(task);
                }
                
                // Update the UI for affected dates
                datesToRender.forEach(date => {
                    scheduleTaskRender(date);
                });
                renderTasksList();
                
                // Close the modal
                customTaskModal.style.display = 'none';
                
                // Reset form
                customTaskForm.reset();
                
                // Show success notification
                showNotification(`Task added to ${taskCount} days successfully`);
            } catch (error) {
                console.error('Failed to save custom tasks:', error);
                showNotification('Failed to add tasks. Please try again.', true);
                
                // Revert changes on error
                for (const task of tasksToSave) {
                    if (tasks[task.date]) {
                        tasks[task.date] = tasks[task.date].filter(t => t.id !== task.id);
                        if (tasks[task.date].length === 0) {
                            delete tasks[task.date];
                        }
                    }
                }
            }
        }

        // Clear all tasks
        async function clearAllTasks() {
            if (Object.keys(tasks).length === 0) {
                showNotification('No tasks to clear', true);
                clearAllModal.style.display = 'none';
                return;
            }
            
            try {
                // Clear from IndexedDB
                await clearAllTasksFromDB();
                
                // Clear local state
                tasks = {};
                selectedTaskIds.clear();
                
                scheduleRender();
                showNotification('All tasks have been cleared successfully');
                clearAllModal.style.display = 'none';
            } catch (error) {
                console.error('Failed to clear all tasks:', error);
                showNotification('Failed to clear all tasks. Please try again.', true);
            }
        }

        // Export calendar data
        async function exportData() {
            try {
                const allTasks = await calendarDB.getAllTasks();
                const dataStr = JSON.stringify(allTasks, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `calendar-backup-${formatDate(new Date())}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                showNotification('Calendar data exported successfully');
                backupModal.style.display = 'none';
            } catch (error) {
                console.error('Export failed:', error);
                showNotification('Failed to export data. Please try again.', true);
            }
        }

        // Import calendar data
        async function importData() {
            const file = importFileInput.files[0];
            if (!file) {
                showNotification('Please select a file to import', true);
                return;
            }
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const importedTasks = JSON.parse(e.target.result);
                    
                    // Clear existing data
                    await clearAllTasksFromDB();
                    tasks = {};
                    selectedTaskIds.clear();
                    
                    // Import new tasks
                    for (const task of importedTasks) {
                        await saveTaskToDB(task);
                        if (!tasks[task.date]) {
                            tasks[task.date] = [];
                        }
                        tasks[task.date].push(task);
                    }
                    
                    scheduleRender();
                    showNotification('Calendar data imported successfully');
                    backupModal.style.display = 'none';
                } catch (error) {
                    console.error('Error importing data:', error);
                    showNotification('Error importing data. Please check the file format.', true);
                }
            };
            reader.readAsText(file);
        }

        // Show notification
        function showNotification(message, isError = false) {
            notification.textContent = message;
            notification.classList.toggle('error', isError);
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Set up event listeners
        function setupEventListeners() {
            // Navigation
            prevMonthBtn.addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() - 1);
                renderCalendar();
            });
            
            nextMonthBtn.addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() + 1);
                renderCalendar();
            });
            
            todayBtn.addEventListener('click', () => {
                currentDate = new Date();
                renderCalendar();
            });
            
            // Theme toggle
            themeToggleBtn.addEventListener('click', toggleTheme);
            
            // Task modal
            taskForm.addEventListener('submit', saveTask);
            closeTaskModalBtn.addEventListener('click', () => {
                taskModal.style.display = 'none';
            });
            cancelTaskBtn.addEventListener('click', () => {
                taskModal.style.display = 'none';
            });
            deleteTaskBtn.addEventListener('click', deleteTask);
            
            // Custom task modal
            addCustomTaskBtn.addEventListener('click', () => {
                customTaskModal.style.display = 'flex';
                // Set default dates
                const today = new Date();
                const nextWeek = new Date();
                nextWeek.setDate(today.getDate() + 7);
                
                document.getElementById('custom-task-start-date').value = formatDate(today);
                document.getElementById('custom-task-end-date').value = formatDate(nextWeek);
            });
            
            customTaskForm.addEventListener('submit', addCustomTaskRange);
            closeCustomTaskModalBtn.addEventListener('click', () => {
                customTaskModal.style.display = 'none';
            });
            cancelCustomTaskBtn.addEventListener('click', () => {
                customTaskModal.style.display = 'none';
            });
            
            // Select all days functionality
            selectAllCheckbox.addEventListener('change', () => {
                const isChecked = selectAllCheckbox.checked;
                dayCheckboxes.forEach(checkbox => {
                    checkbox.checked = isChecked;
                });
            });
            
            // Individual day checkbox logic
            dayCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    const allChecked = Array.from(dayCheckboxes).every(cb => cb.checked);
                    selectAllCheckbox.checked = allChecked;
                });
            });
            
            // Backup modal
            backupBtn.addEventListener('click', () => {
                backupModal.style.display = 'flex';
                exportSection.style.display = 'block';
                importSection.style.display = 'none';
                exportOption.classList.add('selected');
                importOption.classList.remove('selected');
            });
            
            closeBackupModalBtn.addEventListener('click', () => {
                backupModal.style.display = 'none';
            });
            
            exportOption.addEventListener('click', () => {
                exportSection.style.display = 'block';
                importSection.style.display = 'none';
                exportOption.classList.add('selected');
                importOption.classList.remove('selected');
            });
            
            importOption.addEventListener('click', () => {
                exportSection.style.display = 'none';
                importSection.style.display = 'block';
                exportOption.classList.remove('selected');
                importOption.classList.add('selected');
            });
            
            exportBtn.addEventListener('click', exportData);
            importBtn.addEventListener('click', importData);
            
            // Clear All modal
            clearAllBtn.addEventListener('click', () => {
                clearAllModal.style.display = 'flex';
            });
            
            closeClearAllModalBtn.addEventListener('click', () => {
                clearAllModal.style.display = 'none';
            });
            
            cancelClearAllBtn.addEventListener('click', () => {
                clearAllModal.style.display = 'none';
            });
            
            confirmClearAllBtn.addEventListener('click', clearAllTasks);
            
            // NEW: Bulk actions event listeners
            bulkDeleteBtn.addEventListener('click', bulkDeleteSelectedTasks);
            clearSelectionBtn.addEventListener('click', clearSelections);
            
            closeBulkDeleteModalBtn.addEventListener('click', () => {
                bulkDeleteModal.style.display = 'none';
            });
            
            cancelBulkDeleteBtn.addEventListener('click', () => {
                bulkDeleteModal.style.display = 'none';
            });
            
            confirmBulkDeleteBtn.addEventListener('click', performBulkDelete);
            
            // NEW: Select all functionality
            document.addEventListener('keydown', (e) => {
                // Ctrl+A to select all visible tasks
                if (e.ctrlKey && e.key === 'a') {
                    e.preventDefault();
                    selectAllVisibleTasks();
                }
            });
            
            // Tasks list controls
            toggleCompletedBtn.addEventListener('click', () => {
                showCompleted = !showCompleted;
                toggleCompletedBtn.textContent = showCompleted ? 'Hide Completed' : 'Show Completed';
                saveSettings();
                renderTasksList();
            });
            
            // Sort controls
            sortSelect.addEventListener('change', () => {
                sortBy = sortSelect.value;
                saveSettings();
                renderTasksList();
            });
            
            sortDirectionBtn.addEventListener('click', () => {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                sortDirectionBtn.textContent = sortDirection === 'asc' ? '‚Üë' : '‚Üì';
                saveSettings();
                renderTasksList();
            });
            
            // Filter buttons
            filterBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    filterBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentFilter = btn.getAttribute('data-filter');
                    saveSettings();
                    renderTasksList();
                });
            });
            
            // Close modals when clicking outside
            window.addEventListener('click', (event) => {
                if (event.target === taskModal) {
                    taskModal.style.display = 'none';
                }
                if (event.target === customTaskModal) {
                    customTaskModal.style.display = 'none';
                }
                if (event.target === backupModal) {
                    backupModal.style.display = 'none';
                }
                if (event.target === clearAllModal) {
                    clearAllModal.style.display = 'none';
                }
                if (event.target === bulkDeleteModal) {
                    bulkDeleteModal.style.display = 'none';
                }
            });

            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    taskModal.style.display = 'none';
                    customTaskModal.style.display = 'none';
                    backupModal.style.display = 'none';
                    clearAllModal.style.display = 'none';
                    bulkDeleteModal.style.display = 'none';
                }
            });
        }

        // Initialize the calendar when the page loads
        document.addEventListener('DOMContentLoaded', initCalendar);
    </script>
</body>
</html>
